<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Explorar Ventas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
</head>

<body>
<div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <a href="{{ url_for('index') }}" class="logo-link">
                <img src="{{ url_for('static', filename='images/logoinvert.png') }}"
                     alt="Logo Lunita Val"
                     class="logo">
            </a>
        </div>

        <nav class="menu">
            <a href="{{ url_for('index') }}" class="menu_btn">Vender</a>
            <a href="{{ url_for('sales.shipments_view') }}" class="menu_btn">Cadeter√≠a</a>
            <a href="{{ url_for('delivery.retiro_view') }}" class="menu_btn">Retiro</a>
            <a href="{{ url_for('delivery.correo_view') }}" class="menu_btn">Correo</a>
            <a href="{{ url_for('explore_sales') }}" class="menu_btn active">Explorar ventas</a>
            <a href="{{ url_for('customers.manage_customers_view') }}" class="menu_btn">Clientes</a>
            <a href="{{ url_for('sales.print_labels_view') }}" class="menu_btn">Imprimir Etiquetas</a>
            <a href="{{ url_for('proximamente_view') }}" class="menu_btn">Venta en Vivo</a>
        </nav>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">

        <!-- HEADER -->
        <header class="header">
            <h1 class="view-title">Explorar Ventas</h1>

            <a href="{{ url_for('index') }}" class="btn">
                Ir a crear venta
            </a>
        </header>

        <!-- MAIN -->
        <main class="content">
            <div class="content-column">

                <!-- FILTROS -->
                <section class="form-panel">
                    <form class="filters" method="get" id="filterForm">

                        <div class="form-group autocomplete-wrapper">
                            <label>Cliente</label>
                            <input type="text"
                                   name="customer"
                                   id="customer-input"
                                   placeholder="Cliente"
                                   autocomplete="off"
                                   value="{{ filters.customer }}">
                            <input type="hidden" id="customer_id" name="customer_id">
                            <div id="customer-suggestions" class="suggestions"></div>
                        </div>

                        <div class="form-group">
                            <label>M√©todo de pago</label>
                            <input type="text"
                                   name="payment_method"
                                   placeholder="M√©todo de pago"
                                   value="{{ filters.payment_method }}">
                        </div>

                        <div class="form-group">
                            <label>Pago</label>
                            <select name="paid">
                                <option value="">Pago / No pago</option>
                                <option value="si" {% if filters.paid == 'si' %}selected{% endif %}>Si</option>
                                <option value="no" {% if filters.paid == 'no' %}selected{% endif %}>No</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Desde</label>
                            <input type="date" name="date_from" value="{{ filters.date_from }}">
                        </div>
                        <div class="form-group">
                            <label>Hasta</label>
                            <input type="date" name="date_to" value="{{ filters.date_to }}">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn">Filtrar</button>
                        </div>

                    </form>
                </section>

                <!-- TABLA -->
                <div class="table-wrapper">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                                <th>M√©todo</th>
                                <th>Pagado</th>
                                <th>Tipo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for s in sales %}
                            <tr>
                                <td>{{ s.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ s.customer.first_name }} {{ s.customer.last_name }}</td>
                                <td class="amount" data-amount="{{ s.amount }}"></td>
                                <td>{{ s.payment_method }}</td>
                                <td class="paid-status">{{ "Si" if s.paid else "No" }}</td>
                                <td>
                                    {% if s.delivery_type == 'cadeteria' %}üì¶ Cadeter√≠a
                                    {% elif s.delivery_type == 'retiro' %}üè™ Retiro
                                    {% elif s.delivery_type == 'correo' %}üìÆ Correo
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('index') }}?edit={{ s.id }}" class="button-edit">
                                        Editar
                                    </a>

                                    <a href="{{ url_for('pdf.download_sale_label', sale_id=s.id) }}"
                                       target="_blank"
                                       class="btn">
                                        Etiqueta
                                    </a>

                                    <button
                                        class="button button-delete"
                                        onclick="deleteSale({{ s.id }})">
                                        Borrar
                                    </button>

                                    {% if not s.paid %}
                                    <button
                                        class="btn-pay"
                                        onclick="markSalePaid({{ s.id }})">
                                        Marcar pago
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- PAGINACI√ìN -->
                <div class="pagination">
                    {% if page > 1 %}
                        <button class="page-btn" onclick="goToPage({{ page - 1 }})">
                            ¬´ Anterior
                        </button>
                    {% else %}
                        <button class="page-btn" disabled>¬´ Anterior</button>
                    {% endif %}

                    <span style="margin: 0 10px;">
                        P√°gina {{ page }} de {{ total_pages }}
                    </span>

                    {% if page < total_pages %}
                        <button class="page-btn" onclick="goToPage({{ page + 1 }})">
                            Siguiente ¬ª
                        </button>
                    {% else %}
                        <button class="page-btn" disabled>Siguiente ¬ª</button>
                    {% endif %}
                </div>

            </div>
        </main>

    </div>
</div>

<script>
// Funci√≥n para ir a p√°gina manteniendo filtros
function goToPage(pageNum) {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    
    const params = new URLSearchParams();
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    params.set('page', pageNum);
    
    window.location.href = '{{ url_for("sales.explore_sales_page") }}?' + params.toString();
}

// Toast
function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.position = "fixed";
    toast.style.top = "20px";
    toast.style.right = "20px";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "5px";
    toast.style.backgroundColor = type === "success" ? "#4caf50" : "#f44336";
    toast.style.color = "white";
    toast.style.zIndex = 9999;
    toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Formatear montos
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.amount').forEach(td => {
        const amount = parseFloat(td.dataset.amount);
        td.textContent = amount.toLocaleString('es-AR', {
            style: 'currency',
            currency: 'ARS',
            minimumFractionDigits: 0
        });
    });
});

// Borrar venta
async function deleteSale(saleId) {
    if (!confirm(`¬øEliminar venta #${saleId}?`)) return;
    
    try {
        const res = await fetch(`/sales/${saleId}`, { method: "DELETE" });
        const result = await res.json();
        showToast(result.message || "Venta eliminada");
        location.reload();
    } catch (error) {
        showToast("Error al eliminar venta", "error");
    }
}

// Marcar como pagado
async function markSalePaid(saleId) {
    try {
        const res = await fetch(`/sales/${saleId}/mark_paid`, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'} 
        });
        
        const data = await res.json();
        
        if (res.ok) {
            showToast(data.message);
            location.reload();
        } else {
            showToast(data.error || 'Error al marcar como pagado', 'error');
        }
    } catch (error) {
        showToast('Error al procesar solicitud', 'error');
    }
}
</script>

<script src="{{ url_for('static', filename='js/explore_sales.js') }}"></script>
</body>
</html>