<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Explorar Ventas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
</head>

<body>
<div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <a href="{{ url_for('index') }}" class="logo-link">
                <img src="{{ url_for('static', filename='images/logoinvert.png') }}"
                     alt="Logo Lunita Val"
                     class="logo">
            </a>
        </div>

        <nav class="menu">
            <a href="{{ url_for('index') }}" class="menu_btn">Vender</a>
            <a href="{{ url_for('sales.shipments_view') }}" class="menu_btn">Gestión de Cadeteria</a>
            <a href="{{ url_for('explore_sales') }}" class="menu_btn">Explorar ventas</a>
            <a href="{{ url_for('customers.manage_customers_view') }}" class="menu_btn">Clientes</a>
            <a href="{{ url_for('delivery.retiro_view') }}" class="menu_btn">Retiro</a>
            <a href="{{ url_for('delivery.correo_view') }}" class="menu_btn">Correo</a>
            <a href="{{ url_for('proximamente_view') }}" class="menu_btn">Venta en Vivo</a>
        </nav>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">

        <!-- HEADER -->
        <header class="header">
            <h1 class="view-title">Explorar Ventas</h1>

            <a href="{{ url_for('index') }}" class="btn">
                Ir a crear venta
            </a>
        </header>

        <!-- MAIN -->
        <main class="content">
            <div class="content-column">

                <!-- FILTROS -->
                <section class="form-panel">
                    <form class="filters" method="get">

                        <div class="form-group autocomplete-wrapper">
                            <label>Cliente</label>
                            <input type="text"
                                   name="customer"
                                   id="customer-input"
                                   placeholder="Cliente"
                                   autocomplete="off"
                                   value="{{ filters.customer }}">
                            <input type="hidden" id="customer_id" name="customer_id">
                            <div id="customer-suggestions" class="suggestions"></div>
                        </div>

                        <div class="form-group">
                            <label>Método de pago</label>
                            <input type="text"
                                   name="payment_method"
                                   placeholder="Método de pago"
                                   value="{{ filters.payment_method }}">
                        </div>

                        <div class="form-group">
                            <label>Pago</label>
                            <select name="paid">
                                <option value="">Pago / No pago</option>
                                <option value="si" {% if filters.paid == 'si' %}selected{% endif %}>Si</option>
                                <option value="no" {% if filters.paid == 'no' %}selected{% endif %}>No</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Desde</label>
                            <input type="date" name="date_from" value="{{ filters.date_from }}">
                        </div>
                        <div class="form-group">
                            <label>Hasta</label>
                            <input type="date" name="date_to" value="{{ filters.date_to }}">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn">Filtrar</button>
                        </div>

                    </form>
                </section>

                <!-- TABLA -->
                <div class="table-wrapper">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                                <th>Método de pago</th>
                                <th>Pagado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for s in sales %}
                            <tr>
                                <td>{{ s.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ s.customer.first_name }} {{ s.customer.last_name }}</td>
                                <td class="amount" data-amount="{{ s.amount }}"></td>
                                <td>{{ s.payment_method }}</td>
                                <td class="paid-status">{{ "Si" if s.paid else "No" }}</td>
                                <td>
                                    <a href="{{ url_for('pdf.download_sale_label', sale_id=s.id) }}"
                                       target="_blank"
                                       class="btn">
                                        Comprobante
                                    </a>

                                    <button
                                        class="button button-delete"
                                        data-url="{{ url_for('sales.delete_existing_sale', id=s.id) }}">
                                        Borrar
                                    </button>

                                    {% if not s.paid %}
                                    <button
                                        class="btn-pay"
                                        data-sale="{{ s.id }}"
                                        data-url="{{ url_for('sales.mark_sale_paid_endpoint', sale_id=s.id) }}">
                                        Marcar pago
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- PAGINACIÓN -->
                <div class="pagination">
                    {% if page > 1 %}
                        <a href="{{ url_for('sales.explore_sales_page', page=page-1,
                            customer=filters.customer,
                            payment_method=filters.payment_method,
                            paid=filters.paid,
                            date_from=filters.date_from,
                            date_to=filters.date_to) }}">
                            « Anterior
                        </a>
                    {% endif %}

                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                            <strong>{{ p }}</strong>
                        {% else %}
                            <a href="{{ url_for('sales.explore_sales_page', page=p,
                                customer=filters.customer,
                                payment_method=filters.payment_method,
                                paid=filters.paid,
                                date_from=filters.date_from,
                                date_to=filters.date_to) }}">
                                {{ p }}
                            </a>
                        {% endif %}
                    {% endfor %}

                    {% if page < total_pages %}
                        <a href="{{ url_for('sales.explore_sales_page', page=page+1,
                            customer=filters.customer,
                            payment_method=filters.payment_method,
                            paid=filters.paid,
                            date_from=filters.date_from,
                            date_to=filters.date_to) }}">
                            Siguiente »
                        </a>
                    {% endif %}
                </div>

            </div>
        </main>

    </div>
</div>

<script src="{{ url_for('static', filename='js/explore_sales.js') }}"></script>
</body>
</html>
